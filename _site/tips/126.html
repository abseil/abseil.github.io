<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="title" content="Abseil open-source foundational code">
    <meta name="description" content="Battle-tested, Mom-approved">
    <title>abseil / Tip of the Week #126: `make_unique` is the new `new`</title>

    <!-- Fontawesome Icons -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    
    <!-- Favicons -->
    <link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico" />
    
    <!-- Bootstrap -->
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Site style using SASS, generated by from style.scss -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Slick styling -->
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/jquery.slick/1.6.0/slick.css"/>
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/jquery.slick/1.6.0/slick-theme.css"/>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- metadata -->
    <meta name="og:title" content="abseil / Tip of the Week #126: `make_unique` is the new `new`"/>
	 <meta name="og:description" content="An open-source collection of core C++ library code"/>
  </head>
  <body class=>

  	<nav id="sticky-nav">
  <div class="nav-container container">
    <div class="row">
      <div class="col-md-11 nofloat center-block">
        <a class="col-xs-2" href="/">
          <img class="nav-logo" src="/img/absl_18px.svg" alt="Abseil">
        </a>

        <div class="col-xs-2 col-xs-offset-8">
          <button type="button" class="hamburger navbar-toggle collapsed" data-target="#navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>

        <ul class="nav col-xs-10">
          
          <li><a href="/about" >About</a></li>
          <li><a href="/docs/" >Docs</a></li>
		  <li><a href="/tips/" class='current'>Tips</a></li>
          <li><a href="/blog/" >Blog</a></li>
          <li><a href="/community/" >Community</a></li>
        </ul>

      </div>
    </div>
  </div>

  <div class="top-nav right">
    
    <li class="nav-item"><a href="/"><p>Home</p></a><div class="nav-toggle icon-close"></div></li>
    <hr>
    <li class="nav-item"><a href="/about" ><p>About</p></a></li>
    <hr>
    <li class="nav-item"><a href="/docs/" ><p>Docs</p></a>
      <div class="nav-doc-toggle icon-caret"></div>
      <ul class="doc-list">
        <a href="/docs/cpp" ><li class="nav-doc-tab">C++ Devguide</li></a>
        <a href="/docs/cpp/quickstart" ><li class="nav-doc-tab">C++ Quick Start</li></a>
      </ul>
    </li>
    <hr>
    <li class="nav-item"><a href="/tips/" class='current'><p>Tips</p></a></li>
    <hr>
    <li class="nav-item"><a href="/blog/" ><p>Blog</p></a></li>
    <hr>
    <li class="nav-item"><a href="/community/" ><p>Community</p></a></li>
  </div>
</nav>


<div class="nav-hero-container">
	<nav id="common-nav">
  <div class="nav-container container">
    <div class="row">
      <div class="col-md-11 nofloat center-block">
        <a class="col-xs-2" href="/">
          <img class="nav-logo" src="/img/absl_80px.png" alt="Abseil">
        </a>

        <div class="col-xs-2 col-xs-offset-8">
          <button type="button" class="hamburger navbar-toggle collapsed" data-target="#navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>

        <ul class="nav col-xs-10">
          
          <li><a href="/about" >About</a></li>
          <li><a href="/docs/" >Docs</a></li>
          <li><a href="/tips/" class='current'>C++ Tips</a></li>
		  <li><a href="/blog/" >Blog</a></li>
          <li><a href="/community" >Community</a></li>
        </ul>

      </div>
    </div>
  </div>

  <div class="top-nav right">
    
    <li class="nav-item"><a href="/"><p>Home</p></a><div class="nav-toggle icon-close"></div></li>
    <hr>
    <li class="nav-item"><a href="/about/" ><p>About</p></a></li>
    <hr>
    <li class="nav-item"><a href="/docs/" ><p>Docs</p></a>
      <div class="nav-doc-toggle icon-caret"></div>
      <ul class="doc-list">
        <a href="/docs/cpp/quickstart" ><li class="nav-doc-tab">Quickstart</li></a>
      </ul>
    </li>
    <hr>
    <li class="nav-item"><a href="/blog/" ><p>Blog</p></a></li>
    <hr>
    <li class="nav-item"><a href="/tips/" class='current'><p>Tips</p></a></li>
    <hr>
    <li class="nav-item"><a href="/community/" ><p>Community</p></a></li>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-md-11 nofloat center-block">
        <div class="col-xs-12">
          <h1 class="page-headline"></h1> 
        </div>
      </div>
    </div>
  </div>

</nav>

   <a href="https://github.com/abseil/" class="fork-btn" target="_blank"></a>

</div>



<div class="container">
<div class="row">
<div class="col-md-12 nofloat center-block ">
<div class="col-sm-3">
<ul class="doc-side-nav">
   <li><h5 class="doc-side-nav-title">
    <a href="/tips/">C++ Tips</a></h5>
   </li>
   

   
     
   
     
   
     
   
     
   
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/1">TotW #1: string_view</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/42">TotW #42: Prefer Factory Functions to Initializer Methods</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/49">TotW #49: Argument-Dependent Lookup</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/55">TotW #55: Name Counting and unique_ptr</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/64">TotW #64: Raw String Literals</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/65">TotW #65: Putting Things in their Place</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/74">TotW #74: Delegating and Inheriting Constructors</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/77">TotW #77: Temporaries, Moves, and Copies</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/86">TotW #86: Enumerating with Class</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/94">TotW #94: Callsite Readability and bool Parameters</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/99">TotW #99: Nonmember Interface Etiquette</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/101">TotW #101: Return Values, References, and Lifetimes</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/107">TotW #107: Reference Lifetime Extension</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/109">TotW #109: Meaningful `const` in Function Declarations</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/112">TotW #112: emplace vs. push_back</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/119">TotW #119: Using-declarations and namespace aliases</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/122">TotW #122: Test Fixtures, Clarity, and Dataflow</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/123">TotW #123: <code>absl::optional</code> and <code>std::unique_ptr</code></a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/126">TotW #126: `make_unique` is the new `new`</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/130">TotW #130: Namespace Naming</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/131">TotW #131: Special Member Functions and `= default`</a></h6>
     </li>
     
   
     
     <li><h6 class="doc-side-nav-list-item">
         <a href="/tips/135">TotW #135: Test the Contract, not the Implementation</a></h6>
     </li>
     
   
 </ul>

</div>
<div class="col-sm-8 markdown">
<h1>Tip of the Week #126: `make_unique` is the new `new`</h1>
<p>Originally posted as totw/126 on 2016-12-12</p>

<p>By James Dennett <a href="mailto:jdennett@google.com">(jdennett@google.com)</a> based on a
mailing list post by Titus Winters <a href="mailto:titus@google.com">(titus@google.com)</a></p>

<p>As a codebase expands it is increasingly difficult to know the details of
everything you depend on. Requiring deep knowledge doesn’t scale: we have to
rely on interfaces and contracts to know that code is correct, both when writing
and when reviewing. In many cases the type system can provide those contracts in
a common fashion. Consistent use of type system contracts makes for easier
authoring and reviewing of code by identifying places where there are
potentially risky allocations or ownership transfers for objects allocated on
the heap.</p>

<p>While in C++ we can reduce the need for dynamic memory allocation by using plain
values, sometimes we need objects to outlive their scope. C++ code should prefer
smart pointers (most commonly <code class="highlighter-rouge">std::unique_ptr</code>) instead of raw pointers when
dynamically allocating objects. This provides a consistent story around
allocation and ownership transfer, and leaves a clearer visual signal where
there’s code that needs closer inspection for ownership issues. The side effect
of matching how allocation works in the outside world post-C++14 and being
exception safe is just icing.</p>

<p>Two key tools for this are <code class="highlighter-rouge">absl::make_unique()</code> (a C++11 implementation of
C++14’s <code class="highlighter-rouge">std::make_unique()</code>, for leak-free dynamic allocation) and
<code class="highlighter-rouge">absl::WrapUnique()</code> (for wrapping owned raw pointers into the corresponding
<code class="highlighter-rouge">std::unique_ptr</code> types). They can be found in
<a href="https://github.com/abseil/abseil-cpp/blob/master/absl/memory/memory.h">absl/memory/memory.h</a>.</p>

<h2 id="why-avoid-new">Why Avoid <code class="highlighter-rouge">new</code>?</h2>

<p>Why should code prefer smart pointers and these allocation functions over raw
pointers and <code class="highlighter-rouge">new</code>?</p>

<ol>
  <li>
    <p>When possible, ownership is best expressed in the type system. This allows
reviewers to verify correctness (absence of leaks and of double-deletes)
almost entirely by local inspection. (In code that is exceptionally
performance sensitive, this may be excused: while cheap, passing
<code class="highlighter-rouge">std::unique_ptr</code> across function boundaries by value has non-zero overhead
because of ABI constraints. That’s rarely important enough to justify
avoiding it.)</p>
  </li>
  <li>
    <p>Somewhat like the reasoning for preferring <code class="highlighter-rouge">push_back()</code> over
<code class="highlighter-rouge">emplace_back()</code> (<a href="/tips/112">TotW 112</a>), <code class="highlighter-rouge">absl::make_unique()</code> directly
expresses the intent and can only do one thing (do the allocation with a
public constructor, returning a <code class="highlighter-rouge">std::unique_ptr</code> of the specified
type). There’s no type conversion or hidden behavior. <code class="highlighter-rouge">absl::make_unique()</code>
does what it says on the tin.</p>
  </li>
  <li>
    <p>The same could be achieved with <code class="highlighter-rouge">std::unique_ptr&lt;T&gt; my_t(new T(args));</code> but
that is redundant (repeating the type name <code class="highlighter-rouge">T</code>) and for some people there’s
value in minimizing calls to <code class="highlighter-rouge">new</code>. More on this in #5.</p>
  </li>
  <li>
    <p>If all allocations are handled via <code class="highlighter-rouge">absl::make_unique()</code> or factory calls,
that leaves <code class="highlighter-rouge">absl::WrapUnique()</code> for the implementation of those factory
calls, for code interacting with legacy methods that don’t rely on
<code class="highlighter-rouge">std::unique_ptr</code> for ownership transfer, and for rare cases that need to
dynamically allocate with aggregate initialization (<code class="highlighter-rouge">absl::WrapUnique(new
MyStruct{3.141, "pi"})</code>). In code review it’s easy to spot the
<code class="highlighter-rouge">absl::WrapUnique</code> calls and evaluate “does that expression look like an
ownership transfer?” Usually it’s obvious (for example, it’s some factory
function). When it’s not obvious, we need to check the function to be sure
that it’s actually a raw-pointer ownership transfer.</p>
  </li>
  <li>
    <p>If we instead rely mostly on the constructors of <code class="highlighter-rouge">std::unique_ptr</code>, we see
calls like: \
<code class="highlighter-rouge">std::unique_ptr&lt;T&gt; foo(Blah());</code> \
<code class="highlighter-rouge">std::unique_ptr&lt;T&gt; bar(new T());</code> \
It takes only a moment’s inspection to see that the latter is safe (no leak,
no double-delete). The former? It depends: if <code class="highlighter-rouge">Blah()</code> is returning a
<code class="highlighter-rouge">std::unique_ptr</code>, it’s fine, though in that case it would be more obviously
safe if written as \
<code class="highlighter-rouge">std::unique_ptr&lt;T&gt; foo = Blah();</code> \
If <code class="highlighter-rouge">Blah()</code> is returning an ownership-transferred raw pointer, that’s also
fine. If <code class="highlighter-rouge">Blah()</code> is returning just some random pointer (no transfer), then
there’s a problem. Reliance on <code class="highlighter-rouge">absl::make_unique()</code> and <code class="highlighter-rouge">absl::WrapUnique()</code>
(avoiding the constructors) provides an additional visual clue for the
places where we have to worry (calls to <code class="highlighter-rouge">absl::WrapUnique()</code>, and only those).</p>
  </li>
</ol>

<h2 id="how-should-we-choose-which-to-use">How Should We Choose Which to Use?</h2>

<ol>
  <li>
    <p>By default, use <code class="highlighter-rouge">absl::make_unique()</code> (or <code class="highlighter-rouge">std::make_shared()</code> for the rare
cases where shared ownership is appropriate) for dynamic allocation. For
example, instead of: <code class="highlighter-rouge">std::unique_ptr&lt;T&gt; bar(new T());</code> write <code class="highlighter-rouge">auto bar
= absl::make_unique&lt;T&gt;();</code> and instead of <code class="highlighter-rouge">bar.reset(new T());</code> write
<code class="highlighter-rouge">bar = absl::make_unique&lt;T&gt;();</code></p>
  </li>
  <li>
    <p>In a factory function that uses a non-public constructor, return a
<code class="highlighter-rouge">std::unique_ptr&lt;T&gt;</code> and use <code class="highlighter-rouge">absl::WrapUnique(new T(...))</code> in the
implementation.</p>
  </li>
  <li>
    <p>When dynamically allocating an object that requires brace initialization
(typically a struct, an array, or a container), use <code class="highlighter-rouge">absl::WrapUnique(new
T{...})</code>.</p>
  </li>
  <li>
    <p>When calling a legacy API that accepts ownership via a <code class="highlighter-rouge">T*</code>, either allocate
the object in advance with <code class="highlighter-rouge">absl::make_unique</code> and call <code class="highlighter-rouge">ptr.release()</code> in
the call, or use <code class="highlighter-rouge">new</code> directly in the function argument.</p>
  </li>
  <li>
    <p>When calling a legacy API that returns ownership via a <code class="highlighter-rouge">T*</code>, immediately
construct a smart pointer with <code class="highlighter-rouge">WrapUnique</code> (unless you’re immediately
passing the pointer to another legacy API that accepts ownership via a
<code class="highlighter-rouge">T*</code>).</p>
  </li>
</ol>

<h2 id="summary">Summary</h2>

<p>Prefer <code class="highlighter-rouge">absl::make_unique()</code> over <code class="highlighter-rouge">absl::WrapUnique()</code>, and prefer
<code class="highlighter-rouge">absl::WrapUnique()</code> over raw <code class="highlighter-rouge">new</code>.</p>

</div>

<div id="toc" class="col-sm-1"></div>
<br />
<a href="http://feeds.feedburner.com/abseilio"
    title="Subscribe to Abseil Blog &amp; Tips"
    rel="alternate"
    type="application/rss+xml">
    <img src="//feedburner.google.com/fb/images/pub/feed-icon32x32.png"
         alt="Subscribe to the Abseil Blog" style="border:0;">
    </img>
</a>
</div>
</div>
</div>




<footer>
    <div class="container">
        <div class="left-links">
            <img src="/img/typography_white.png" style="height:24px;"/>
            <p class="description">&copy;2017 Abseil | Live at Head</p>
        </div>
        <div class="right-links">
            <div class="col-md-4 col-sm-4 col-xs-12 footer-documentation">
                <ul class="toggle">
                    <a href="/about/"><p class="right-link-headers">About Abseil</p></a>
                    <li><a href="/about/intro"><p>Introduction</p></a></li>
                    <li><a href="/about/philosophy"><p>Philosophy</p></a></li>
                    <li><a href="/about/compatibility"><p>Compatibility</p></a></li>
                    <li><a href="/about/design/"><p>Design Notes</p><a></li>
                 </ul>
            </div>
            <hr class="footer-sections" />
            <div class="col-md-3 col-sm-3 col-xs-12 footer-resources">
                <ul class="toggle">
                    <a href="/docs/"><p class="right-link-headers">Dev Guides</p></a>
                    <li><a href="/docs/cpp.html"><p>C++</p></a></li>
                    <li><a href="/blog/"><p>Abseil Blog</p></a></li>
                </ul>
                </ul>
            </div>
            <hr class="footer-sections" />
            <div class="col-md-5 col-sm-5 col-xs-12 footer-community">
                <ul class="toggle">
                    <a href="/community/"><p class="right-link-headers">Community</p></a>
                    <li><a href="https://github.com/abseil/" target="_blank"><p class="github community-links">GitHub</p></a></li>
                    <li><a href="https://twitter.com/abseilio" target="_blank"><p class="twitter community-links">Twitter</p></a></li>
                    <li><a href="http://stackoverflow.com/tags/abseil/" target="_blank"><p class="stack-overflow community-links">Stack Overflow</p></a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>


    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>
    <!-- Include SlickJS for carousel -->
    <script src="/js/slick.min.js"></script>
    <script src="/js/jquery.visible.min.js"></script>
    <!-- Include the common site javascript -->
    <script src="/js/common.js" type="text/javascript" charset="utf-8"></script>
    <!-- GA -->
    <script src="/js/waves.js"></script>
    <script src="/js/buttons.js"></script>
    
    

    
	
	<!-- Global Site Tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-106933809-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments)};
	  gtag('js', new Date());

	  gtag('config', 'UA-106933809-1');
	</script>

  </body>
</html>

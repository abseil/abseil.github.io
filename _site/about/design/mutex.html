<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="title" content="Abseil open-source foundational code">
    <meta name="description" content="Battle-tested, Mom-approved">
    <title>abseil / absl::Mutex Design Notes</title>

    <!-- Fontawesome Icons -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    
    <!-- Favicons -->
    <link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico" />
    
    <!-- Bootstrap -->
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Site style using SASS, generated by from style.scss -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Slick styling -->
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/jquery.slick/1.6.0/slick.css"/>
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/jquery.slick/1.6.0/slick-theme.css"/>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- metadata -->
    <meta name="og:title" content="abseil / absl::Mutex Design Notes"/>
	 <meta name="og:description" content="An open-source collection of core C++ library code"/>
  </head>
  <body class=>

  	<nav id="sticky-nav">
  <div class="nav-container container">
    <div class="row">
      <div class="col-md-11 nofloat center-block">
        <a class="col-xs-2" href="/">
          <img class="nav-logo" src="/img/absl_18px.svg" alt="Abseil">
        </a>

        <div class="col-xs-2 col-xs-offset-8">
          <button type="button" class="hamburger navbar-toggle collapsed" data-target="#navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>

        <ul class="nav col-xs-10">
          
          <li><a href="/about" class='current'>About</a></li>
          <li><a href="/docs/" >Docs</a></li>
		  <li><a href="/tips/" >Tips</a></li>
          <li><a href="/blog/" >Blog</a></li>
          <li><a href="/community/" >Community</a></li>
        </ul>

      </div>
    </div>
  </div>

  <div class="top-nav right">
    
    <li class="nav-item"><a href="/"><p>Home</p></a><div class="nav-toggle icon-close"></div></li>
    <hr>
    <li class="nav-item"><a href="/about" class='current'><p>About</p></a></li>
    <hr>
    <li class="nav-item"><a href="/docs/" ><p>Docs</p></a>
      <div class="nav-doc-toggle icon-caret"></div>
      <ul class="doc-list">
        <a href="/docs/cpp" ><li class="nav-doc-tab">C++ Devguide</li></a>
        <a href="/docs/cpp/quickstart" ><li class="nav-doc-tab">C++ Quick Start</li></a>
      </ul>
    </li>
    <hr>
    <li class="nav-item"><a href="/tips/" ><p>Tips</p></a></li>
    <hr>
    <li class="nav-item"><a href="/blog/" ><p>Blog</p></a></li>
    <hr>
    <li class="nav-item"><a href="/community/" ><p>Community</p></a></li>
  </div>
</nav>


<div class="nav-hero-container">
	<nav id="common-nav">
  <div class="nav-container container">
    <div class="row">
      <div class="col-md-11 nofloat center-block">
        <a class="col-xs-2" href="/">
          <img class="nav-logo" src="/img/absl_80px.png" alt="Abseil">
        </a>

        <div class="col-xs-2 col-xs-offset-8">
          <button type="button" class="hamburger navbar-toggle collapsed" data-target="#navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>

        <ul class="nav col-xs-10">
          
          <li><a href="/about" class='current'>About</a></li>
          <li><a href="/docs/" >Docs</a></li>
          <li><a href="/tips/" >C++ Tips</a></li>
		  <li><a href="/blog/" >Blog</a></li>
          <li><a href="/community" >Community</a></li>
        </ul>

      </div>
    </div>
  </div>

  <div class="top-nav right">
    
    <li class="nav-item"><a href="/"><p>Home</p></a><div class="nav-toggle icon-close"></div></li>
    <hr>
    <li class="nav-item"><a href="/about/" class='current'><p>About</p></a></li>
    <hr>
    <li class="nav-item"><a href="/docs/" ><p>Docs</p></a>
      <div class="nav-doc-toggle icon-caret"></div>
      <ul class="doc-list">
        <a href="/docs/cpp/quickstart" ><li class="nav-doc-tab">Quickstart</li></a>
      </ul>
    </li>
    <hr>
    <li class="nav-item"><a href="/blog/" ><p>Blog</p></a></li>
    <hr>
    <li class="nav-item"><a href="/tips/" ><p>Tips</p></a></li>
    <hr>
    <li class="nav-item"><a href="/community/" ><p>Community</p></a></li>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-md-11 nofloat center-block">
        <div class="col-xs-12">
          <h1 class="page-headline"></h1> 
        </div>
      </div>
    </div>
  </div>

</nav>

   <a href="https://github.com/abseil/" class="fork-btn" target="_blank"></a>

</div>



<div class="container">
<div class="row">
<div class="col-md-11 nofloat center-block ">
<div class="col-sm-3">
<ul class="doc-side-nav">
   
	<li><h5 class="doc-side-nav-title"><a href="/about/">About</a></h5></li>
	<li class="doc-side-nav-list-item">
	<a href="/about/intro" >
	Introduction</a></li>
	<li class="doc-side-nav-list-item">
	<a href="/about/philosophy" >
	Philosophy</a></li>
	<li class="doc-side-nav-list-item">
	<a href="/about/compatibility" >
	Compatibility</a></li>
   <li class="doc-side-nav-title">
   <a href="/about/design/" class='current'>
   Design Notes</a></li>
  <li class="doc-side-nav-list-item">
  <a href="/about/design/mutex" class='current'>
   absl::Mutex</a></li>
   <li class="doc-side-nav-list-item">
   <a href="/about/design/dropin-types" >
   Pre-Adopted std:: types</a></li>
 </ul>

</div>
<div class="col-sm-7 markdown">
<h2 id="abslmutex"><code class="highlighter-rouge">absl::Mutex</code></h2>

<p>Abseil uses and has published its own <code class="highlighter-rouge">absl::Mutex</code> abstraction in place of the
C++ library’s <code class="highlighter-rouge">std::mutex</code> implementation. Such a decision is not advocated
lightly. This design note attempts to lay out all of the issues surrounding
<code class="highlighter-rouge">absl::Mutex</code> vs. <code class="highlighter-rouge">std::mutex</code> in light of usage at Google, while also noting
the API differences, performance issues, and extra features we’ve found useful.
We also discuss the refactoring costs and portability issues that influenced our
decision to stick with our implementation and open-source it.</p>

<p>Given that background we hope to reason about short and long term plans for a
mutex vocabulary type within Google and Abseil, and the implications of having
<code class="highlighter-rouge">absl::Mutex</code> and <code class="highlighter-rouge">std::mutex</code> live alongside each other going forward.</p>

<h2 id="api-issues">API Issues</h2>

<p><code class="highlighter-rouge">absl::Mutex</code> provides its own <code class="highlighter-rouge">absl::Condition</code> abstraction. The interplay
between <code class="highlighter-rouge">absl::Mutex</code> and <code class="highlighter-rouge">absl::Condition</code>, especially in APIs like
<code class="highlighter-rouge">absl::Mutex::Await()</code> and <code class="highlighter-rouge">absl::Mutex::LockWhen()</code>, is different than the
standard mutex / condition model.</p>

<table>
  <tr>
    <th>absl::Mutex Usage</th>
    <th>std::mutex Usage</th>
  </tr>
  <tr>
    <td>worker.cc</td>
    <td>worker.cc</td>
  </tr>
  <tr>
    <td>
<pre>
void Finish() {
  shared_lock_-&gt;Lock();
  shared_state_ += 1;
  shared_lock_-&gt;Unlock();
}
</pre>
    </td>
    <td>
<pre>
void Finish() {
  shared_lock_-&gt;lock();
  shared_state_ += 1;
  shared_lock_-&gt;unlock();
  shared_cv_-&gt;notify_one();
}
</pre>
    </td>
  </tr>
  <tr>
    <td>waiter.cc</td>
    <td>waiter.cc</td>
  </tr>
  <tr>
    <td>
<pre>
void Wait() {
  shared_lock_-&gt;Lock();
  shared_lock_-&gt;Await(Condition([this]() {
      return shared_state_ == 1;
  }));
  shared_lock_-&gt;Unlock();
}
</pre>
    </td>
    <td>
<pre>
void Wait() {
  shared_lock_-&gt;lock();
  shared_cv_-&gt;wait(*shared_lock_, []() {
    return shared_state_ == 1;
  });
  shared_lock_-&gt;unlock();
}
</pre>
    </td>
  </tr>
</table>

<p>Note in particular that the condition is only needed in the waiter in the
Abseil version, and it is impossible to forget to notify about a state update.
In conjunction with added annotations (provided in
<code class="highlighter-rouge">absl/base/thread_annotations.h</code>) and enforcement of locking behavior by
<a href="https://clang.llvm.org/docs/ThreadSanitizer.html">TSAN</a>, this significantly
reduces programming errors: the API is harder to misuse. The general feeling in
discussions about <code class="highlighter-rouge">absl::Mutex</code> has been “We prefer this API.”</p>

<h2 id="performance-issues">Performance Issues</h2>

<p>It has been proposed that having a combination Reader/Writer lock by default is
unnecessarily complex; if the lock isn’t held for long, no benefit acrues, but
the machinery and complexity for tracking readers and writers is in place
regardless.</p>

<p>That said, microbenchmark comparisons between base <code class="highlighter-rouge">absl::Mutex</code> and
<code class="highlighter-rouge">std::mutex</code> look equivalent — any performance penalty is equalled by the
<code class="highlighter-rouge">std::mutex</code> implementation.</p>

<h2 id="extra-features">Extra Features</h2>

<p>Aside from API compatibility, <code class="highlighter-rouge">absl::Mutex</code> contains a number of extra features
that are not supported in <code class="highlighter-rouge">std::mutex</code> and which would be painful to lose within
Google if we somehow shifted to <code class="highlighter-rouge">std::mutex</code>. These additional features include:</p>

<ul>
  <li>Deadlock detection<br />
<code class="highlighter-rouge">absl::Mutex</code> tracks locking order and thread IDs to identify potential
deadlocks. This functionality is duplicated by TSAN, but is enabled in far
more of our builds.</li>
  <li>Contention tracking / reporting<br />
We track the amount of time that each <code class="highlighter-rouge">absl::Mutex</code> is actually contended
(held by T1 while T2 is trying to acquire it), and make that information
available for profiling.  We plan to improve access to this data in a future
release.</li>
  <li>Reader/Writer locks<br />
The <code class="highlighter-rouge">std::mutex</code> class does not support shared (read-only) holds on a lock.
This functionality is available only beginning in C++17 as a separate
<code class="highlighter-rouge">std::shared_mutex</code> class.  <code class="highlighter-rouge">absl::Mutex</code> supports both patterns directly.</li>
</ul>

<h2 id="refactoring-costs">Refactoring Costs</h2>

<p>As a side effect of the API differences (like the unusual handling of
<code class="highlighter-rouge">absl::Condition</code>) and the fact that <code class="highlighter-rouge">absl::Mutex</code> has reader/writer
functionality built into itself, the idea of converting <code class="highlighter-rouge">absl::Mutex</code> to
<code class="highlighter-rouge">std::mutex</code> is seriously complex. We are providing our <code class="highlighter-rouge">absl::Mutex</code> because
we believe in it; its API provides less error-prone and more efficient usage
than the standard, in our opinion. However, we would be remiss to ignore the
concern that refactoring had on our decision, and we provide it here because it
may indeed affect your decision down the road.</p>

<p>An <code class="highlighter-rouge">absl::Mutex</code> is passed through Google interfaces many times, leading to the
(yet unsolved) problem of synchronizing batches of changes across interfaces. At
least for Mutexes that are used across translation units, it may require some
variation of whole-program analysis to identify which mutex features are used
for any given mutex. Rewriting such code is then a matter of expanding a single
<code class="highlighter-rouge">absl::Mutex</code> into a <code class="highlighter-rouge">std::mutex</code> and some number of other types (e.g.
<code class="highlighter-rouge">std::shared_mutex</code>, etc.), and then threading that package of variables through
whatever interfaces are necessary.</p>

<p>This is arguably one of the most complicated large-scale refactoring any
software organization envisions. More specifically: a lot of this refactoring
had no precedent, so this would have been largely a research task. Any
upsides would have to be very strong in order to justify such a change. We
decided the upsides were not that pressing.</p>

<h2 id="portability">Portability</h2>

<p>Even now, 5 years on from C++11, MSVC has at least one significant issue with
<code class="highlighter-rouge">std::mutex</code> compatibility: the lack of a <code class="highlighter-rouge">constexpr</code> constructor for
<code class="highlighter-rouge">std::mutex</code>. An upcoming API tweak to <code class="highlighter-rouge">absl::Mutex</code> will include just such a
<code class="highlighter-rouge">constexpr</code> interface, which is heavily used within Google. Lacking such a
construction is a problem for any large-scale code base that wants to statically
initialize a large number of mutexes.</p>

<h2 id="going-forward">Going Forward</h2>

<p>Code that requires portability on Windows and that isn’t built to specifically
avoid all need for a <code class="highlighter-rouge">constexpr</code> mutex cannot currently rely on the standard.
Moving Abseil code (and Google code) to the standard would have been
phenomenally expensive.</p>

<p>But all those things aside, the prime motivation for our support of
<code class="highlighter-rouge">absl::Mutex</code>, and the reason we are offering it to the open-source community,
is that we prefer our API and think it provides some crucial features. As well,
usage of our <code class="highlighter-rouge">absl::Mutex</code> is easily understood and less error-prone than the
standard offering.</p>

<p>If at some point in the future it becomes easier to perform a migration from
<code class="highlighter-rouge">absl::Mutex</code> to the standard, and the standard solves the problems we mention
here, we may revisit our assumptions, but in all likelihood we will support
<code class="highlighter-rouge">absl::Mutex</code> indefinitely.</p>

</div>

<div id="toc" class="toc col-sm-2"></div>
</div>
</div>
</div>




<footer>
    <div class="container">
        <div class="left-links">
            <img src="/img/typography_white.png" style="height:24px;"/>
            <p class="description">&copy;2017 Abseil | Live at Head</p>
        </div>
        <div class="right-links">
            <div class="col-md-4 col-sm-4 col-xs-12 footer-documentation">
                <ul class="toggle">
                    <a href="/about/"><p class="right-link-headers">About Abseil</p></a>
                    <li><a href="/about/intro"><p>Introduction</p></a></li>
                    <li><a href="/about/philosophy"><p>Philosophy</p></a></li>
                    <li><a href="/about/compatibility"><p>Compatibility</p></a></li>
                    <li><a href="/about/design/"><p>Design Notes</p><a></li>
                 </ul>
            </div>
            <hr class="footer-sections" />
            <div class="col-md-3 col-sm-3 col-xs-12 footer-resources">
                <ul class="toggle">
                    <a href="/docs/"><p class="right-link-headers">Dev Guides</p></a>
                    <li><a href="/docs/cpp.html"><p>C++</p></a></li>
                    <li><a href="/blog/"><p>Abseil Blog</p></a></li>
                </ul>
                </ul>
            </div>
            <hr class="footer-sections" />
            <div class="col-md-5 col-sm-5 col-xs-12 footer-community">
                <ul class="toggle">
                    <a href="/community/"><p class="right-link-headers">Community</p></a>
                    <li><a href="https://github.com/abseil/" target="_blank"><p class="github community-links">GitHub</p></a></li>
                    <li><a href="https://twitter.com/abseilio" target="_blank"><p class="twitter community-links">Twitter</p></a></li>
                    <li><a href="http://stackoverflow.com/tags/abseil/" target="_blank"><p class="stack-overflow community-links">Stack Overflow</p></a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>


    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>
    <!-- Include SlickJS for carousel -->
    <script src="/js/slick.min.js"></script>
    <script src="/js/jquery.visible.min.js"></script>
    <!-- Include the common site javascript -->
    <script src="/js/common.js" type="text/javascript" charset="utf-8"></script>
    <!-- GA -->
    <script src="/js/waves.js"></script>
    <script src="/js/buttons.js"></script>
    
    

    
	
	<!-- Global Site Tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-106933809-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments)};
	  gtag('js', new Date());

	  gtag('config', 'UA-106933809-1');
	</script>

  </body>
</html>
